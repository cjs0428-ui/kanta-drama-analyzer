<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KANTA 숏드라마 분석기</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState } = React;
    const { Upload, FileVideo, Loader, CheckCircle, Download, Sparkles, Key, AlertCircle } = lucide;

    function App() {
      // API 키 상태
      const [apiKeys, setApiKeys] = useState({
        assemblyAI: '',
        openAI: ''
      });
      const [keysSet, setKeysSet] = useState(false);
      
      const [step, setStep] = useState(0);
      const [videoFile, setVideoFile] = useState(null);
      const [uploading, setUploading] = useState(false);
      const [transcribing, setTranscribing] = useState(false);
      const [translating, setTranslating] = useState(false);
      const [analyzing, setAnalyzing] = useState(false);
      const [generatingAd, setGeneratingAd] = useState(false);
      
      const [uploadedVideoUrl, setUploadedVideoUrl] = useState('');
      const [transcriptionId, setTranscriptionId] = useState('');
      const [japaneseText, setJapaneseText] = useState('');
      const [koreanText, setKoreanText] = useState('');
      const [storyAnalysis, setStoryAnalysis] = useState('');
      const [adCopy, setAdCopy] = useState('');
      
      const [adCriteria, setAdCriteria] = useState({
        targetAge: '20-30대',
        tone: '감성적',
        platform: '인스타그램',
        length: '짧게 (1-2줄)',
        keyword: ''
      });

      // API 키 저장
      const handleSaveKeys = () => {
        if (!apiKeys.assemblyAI.trim() || !apiKeys.openAI.trim()) {
          alert('두 개의 API 키를 모두 입력해주세요.');
          return;
        }
        setKeysSet(true);
        setStep(1);
      };

      // 파일을 Base64로 변환
      const fileToBase64 = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      };

      // 1. 영상 업로드
      const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('video/')) {
          setVideoFile(file);
        } else {
          alert('비디오 파일만 업로드 가능합니다.');
        }
      };

      const handleUpload = async () => {
        if (!videoFile) {
          alert('파일을 선택해주세요.');
          return;
        }

        setUploading(true);

        try {
          // 파일을 Base64로 변환
          const videoBase64 = await fileToBase64(videoFile);

          const response = await fetch('/api/upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              videoBase64,
              assemblyAIKey: apiKeys.assemblyAI
            })
          });
          
          const data = await response.json();
          
          if (!data.success) {
            throw new Error(data.error || 'Upload failed');
          }
          
          setUploadedVideoUrl(data.url);
          setStep(2);
          
          handleTranscribe(data.url);
        } catch (error) {
          console.error('업로드 실패:', error);
          alert('업로드에 실패했습니다: ' + error.message);
        } finally {
          setUploading(false);
        }
      };

      // 2. 음성 인식
      const handleTranscribe = async (videoUrl) => {
        setTranscribing(true);
        
        try {
          const
