<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KANTA ìˆë“œë¼ë§ˆ ë¶„ì„ê¸°</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #f5f3ff 0%, #fce7f3 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 20px; }
    h1 { font-size: 2.5rem; text-align: center; margin-bottom: 10px; }
    h2 { font-size: 1.5rem; margin-bottom: 20px; }
    p { text-align: center; color: #666; margin-bottom: 30px; }
    label { display: block; font-weight: 600; margin-bottom: 8px; }
    input[type="password"], input[type="text"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; font-size: 16px; }
    button { width: 100%; padding: 15px; background: #9333ea; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    button:hover:not(:disabled) { background: #7e22ce; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .file-zone { border: 2px dashed #ddd; border-radius: 8px; padding: 60px 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
    .file-zone:hover { border-color: #9333ea; background: #faf5ff; }
    .file-zone .icon { font-size: 4rem; margin-bottom: 20px; }
    .hidden { display: none; }
    .info { background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 14px; color: #1e40af; }
    .error { background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; padding: 20px; margin: 20px 0; color: #dc2626; white-space: pre-wrap; }
    .success { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 20px; margin: 20px 0; color: #16a34a; white-space: pre-wrap; }
    .warning { background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 20px; margin: 20px 0; color: #d97706; }
    .log { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    .log-item { margin: 5px 0; padding: 5px; }
    .log-info { color: #0ea5e9; }
    .log-success { color: #16a34a; }
    .log-error { color: #dc2626; }
    .log-warning { color: #d97706; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ KANTA ìˆë“œë¼ë§ˆ ë¶„ì„ê¸°</h1>
    <p>ì¼ë³¸ ë“œë¼ë§ˆ ëŒ€ì‚¬ë¥¼ ìë™ìœ¼ë¡œ ë²ˆì—­í•˜ê³  ë¶„ì„í•´ì„œ ê´‘ê³  ë¬¸êµ¬ë¥¼ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤</p>

    <!-- ë¡œê·¸ íŒ¨ë„ -->
    <div class="card">
      <h2>ğŸ“‹ ì‹¤í–‰ ë¡œê·¸</h2>
      <div id="logPanel" class="log"></div>
      <button id="clearLogBtn" style="margin-top: 10px; background: #6b7280;">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <!-- Step 0: API í‚¤ ì…ë ¥ -->
    <div id="step0" class="card">
      <h2>ğŸ”‘ API í‚¤ ì„¤ì •</h2>
      <div class="info">
        <p style="margin: 0;">ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
        <ul style="margin-left: 20px; margin-top: 10px;">
          <li>AssemblyAI: ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜</li>
          <li>OpenAI: ë²ˆì—­, ë¶„ì„, ê´‘ê³  ìƒì„±</li>
        </ul>
      </div>
      
      <label>AssemblyAI API Key 
        <a href="https://www.assemblyai.com/dashboard" target="_blank" style="color: #9333ea; font-size: 12px;">(ë°œê¸‰ë°›ê¸° â†’)</a>
      </label>
      <input type="password" id="assemblyKey" placeholder="AssemblyAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      
      <label>OpenAI API Key 
        <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #9333ea; font-size: 12px;">(ë°œê¸‰ë°›ê¸° â†’)</a>
      </label>
      <input type="password" id="openaiKey" placeholder="OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      
      <button id="saveKeysBtn">API í‚¤ ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
    </div>

    <!-- Step 1: ì˜ìƒ ì—…ë¡œë“œ -->
    <div id="step1" class="card hidden">
      <h2>ğŸ“¹ ì˜ìƒ ì—…ë¡œë“œ</h2>
      
      <div class="file-zone" id="fileZone">
        <div class="icon">ğŸ“</div>
        <p id="fileName" style="font-size: 18px; font-weight: 600;">í´ë¦­í•´ì„œ ì˜ìƒ ì„ íƒ</p>
        <p id="fileSize" style="font-size: 14px; color: #666;"></p>
      </div>
      <input type="file" id="videoInput" accept="video/*" style="display: none;">
      
      <button id="uploadBtn" class="hidden">ì—…ë¡œë“œ ì‹œì‘</button>
      
      <div id="uploadStatus" class="hidden"></div>
    </div>

    <!-- Step 2: ìŒì„± ì¸ì‹ ì§„í–‰ ì¤‘ -->
    <div id="step2" class="card hidden">
      <h2>ğŸ¤ ìŒì„± ì¸ì‹ ì¤‘</h2>
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 4rem; animation: spin 2s linear infinite; display: inline-block;">â³</div>
        <p style="margin-top: 20px; font-size: 18px; color: #666;">ì¼ë³¸ì–´ ëŒ€ì‚¬ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        <p id="transcribeStatus" style="margin-top: 10px; color: #999;"></p>
      </div>
    </div>
    <style>
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <!-- Step 3: ë²ˆì—­ ë° ê²°ê³¼ -->
    <div id="step3" class="card hidden">
      <h2>ğŸ“ ì¼ë³¸ì–´ ëŒ€ì‚¬ (ì›ë¬¸)</h2>
      <div class="success" id="japaneseResult"></div>
      
      <h2 style="margin-top: 30px;">ğŸ‡°ğŸ‡· í•œê¸€ ë²ˆì—­</h2>
      <div id="translating" class="warning hidden">
        <p>ë²ˆì—­ ì¤‘...</p>
      </div>
      <div class="success hidden" id="koreanResult"></div>
      
      <button id="analyzeBtn" class="hidden" style="margin-top: 20px;">ìŠ¤í† ë¦¬ ë¶„ì„í•˜ê¸°</button>
    </div>

    <!-- Step 4: ìŠ¤í† ë¦¬ ë¶„ì„ -->
    <div id="step4" class="card hidden">
      <h2>ğŸ“Š ìŠ¤í† ë¦¬ ë¶„ì„ ê²°ê³¼</h2>
      <div class="success" id="analysisResult"></div>
      
      <h2 style="margin-top: 30px;">ğŸ¯ ê´‘ê³  ë¬¸êµ¬ ê¸°ì¤€ ì„¤ì •</h2>
      
      <label>íƒ€ê²Ÿ ì—°ë ¹ëŒ€</label>
      <select id="targetAge">
        <option>10ëŒ€</option>
        <option selected>20-30ëŒ€</option>
        <option>40-50ëŒ€</option>
        <option>ì „ì—°ë ¹</option>
      </select>
      
      <label>í†¤ & ë¬´ë“œ</label>
      <select id="tone">
        <option selected>ê°ì„±ì </option>
        <option>ìœ ë¨¸ëŸ¬ìŠ¤</option>
        <option>ì§„ì§€í•œ</option>
        <option>ì„¤ë ˆëŠ”</option>
      </select>
      
      <label>í”Œë«í¼</label>
      <select id="platform">
        <option selected>ì¸ìŠ¤íƒ€ê·¸ë¨</option>
        <option>ìœ íŠœë¸Œ</option>
        <option>í‹±í†¡</option>
      </select>
      
      <label>í‚¤ì›Œë“œ (ì„ íƒ)</label>
      <input type="text" id="keyword" placeholder="ì˜ˆ: ë¡œë§¨ìŠ¤, ë°˜ì „">
      
      <button id="generateAdBtn">ê´‘ê³  ë¬¸êµ¬ ìƒì„±</button>
    </div>

    <!-- Step 5: ê´‘ê³  ë¬¸êµ¬ -->
    <div id="step5" class="card hidden">
      <h2>âœ¨ ìƒì„±ëœ ê´‘ê³  ë¬¸êµ¬</h2>
      <div id="adResult" style="background: linear-gradient(135deg, #fce7f3 0%, #f3e8ff 100%); padding: 30px; border-radius: 12px; font-size: 18px; line-height: 1.8; white-space: pre-wrap;"></div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
        <button id="downloadBtn" style="background: #16a34a;">ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="location.reload()" style="background: #6b7280;">ğŸ”„ ìƒˆë¡œìš´ ë¶„ì„</button>
      </div>
    </div>
  </div>

  <script>
    // ë¡œê·¸ í•¨ìˆ˜
    function addLog(message, type) {
      const logPanel = document.getElementById('logPanel');
      const logItem = document.createElement('div');
      logItem.className = 'log-item log-' + (type || 'info');
      const time = new Date().toLocaleTimeString();
      logItem.textContent = '[' + time + '] ' + message;
      logPanel.appendChild(logItem);
      logPanel.scrollTop = logPanel.scrollHeight;
      console.log('[' + (type || 'info').toUpperCase() + ']', message);
    }

    addLog('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘', 'info');
    
    // ì „ì—­ ë³€ìˆ˜
    let apiKeys = { assemblyAI: '', openAI: '' };
    let selectedFile = null;
    let transcriptionId = null;
    let japaneseText = '';
    let koreanText = '';
    let storyAnalysis = '';

    // DOM ìš”ì†Œ
    const saveKeysBtn = document.getElementById('saveKeysBtn');
    const step0 = document.getElementById('step0');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4');
    const step5 = document.getElementById('step5');
    const fileZone = document.getElementById('fileZone');
    const videoInput = document.getElementById('videoInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const clearLogBtn = document.getElementById('clearLogBtn');
    
    addLog('DOM ìš”ì†Œ ì°¸ì¡° ì™„ë£Œ', 'success');

    // ë¡œê·¸ ì§€ìš°ê¸°
    clearLogBtn.addEventListener('click', function() {
      document.getElementById('logPanel').innerHTML = '';
      addLog('ë¡œê·¸ ì´ˆê¸°í™”ë¨', 'info');
    });

    // API í‚¤ ì €ì¥
    saveKeysBtn.addEventListener('click', function() {
      addLog('API í‚¤ ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨', 'info');
      
      const assemblyKey = document.getElementById('assemblyKey').value.trim();
      const openaiKey = document.getElementById('openaiKey').value.trim();
      
      if (!assemblyKey || !openaiKey) {
        addLog('API í‚¤ ì…ë ¥ ëˆ„ë½', 'error');
        alert('ë‘ ê°œì˜ API í‚¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      apiKeys.assemblyAI = assemblyKey;
      apiKeys.openAI = openaiKey;
      
      addLog('API í‚¤ ì €ì¥ ì™„ë£Œ', 'success');
      addLog('AssemblyAI í‚¤ ê¸¸ì´: ' + assemblyKey.length, 'info');
      addLog('OpenAI í‚¤ ê¸¸ì´: ' + openaiKey.length, 'info');
      
      step0.classList.add('hidden');
      step1.classList.remove('hidden');
      
      addLog('ì˜ìƒ ì—…ë¡œë“œ í™”ë©´ìœ¼ë¡œ ì „í™˜', 'success');
    });

    // íŒŒì¼ ì„ íƒ ì˜ì—­ í´ë¦­
    fileZone.addEventListener('click', function() {
      addLog('íŒŒì¼ ì„ íƒ ì˜ì—­ í´ë¦­ë¨', 'info');
      videoInput.click();
      addLog('íŒŒì¼ ì„ íƒ ëŒ€í™”ìƒì ì—´ë¦¼', 'info');
    });

    // íŒŒì¼ ì„ íƒ
    videoInput.addEventListener('change', function(event) {
      addLog('íŒŒì¼ ì…ë ¥ change ì´ë²¤íŠ¸ ë°œìƒ', 'info');
      
      const file = event.target.files[0];
      
      if (!file) {
        addLog('íŒŒì¼ ì„ íƒ ì·¨ì†Œë¨', 'warning');
        return;
      }
      
      addLog('íŒŒì¼ì´ ì„ íƒë¨!', 'success');
      addLog('íŒŒì¼ëª…: ' + file.name, 'info');
      addLog('íŒŒì¼ íƒ€ì…: ' + file.type, 'info');
      addLog('íŒŒì¼ í¬ê¸°: ' + file.size + ' bytes (' + (file.size / 1024 / 1024).toFixed(2) + ' MB)', 'info');
      
      // ë¹„ë””ì˜¤ íŒŒì¼ ê²€ì¦
      if (!file.type.startsWith('video/')) {
        addLog('ë¹„ë””ì˜¤ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤: ' + file.type, 'error');
        alert('ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nì„ íƒí•œ íŒŒì¼ íƒ€ì…: ' + file.type);
        return;
      }
      
      // íŒŒì¼ ì €ì¥
      selectedFile = file;
      
      // UI ì—…ë°ì´íŠ¸
      document.getElementById('fileName').textContent = 'âœ… ' + file.name;
      document.getElementById('fileSize').textContent = 'í¬ê¸°: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB';
      uploadBtn.classList.remove('hidden');
      
      addLog('íŒŒì¼ ê²€ì¦ ì™„ë£Œ! ì—…ë¡œë“œ ì¤€ë¹„ë¨', 'success');
    });

    // ì—…ë¡œë“œ ë²„íŠ¼ - AssemblyAI ì§ì ‘ ì—…ë¡œë“œ
    uploadBtn.addEventListener('click', async function() {
      addLog('=== ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ===', 'info');
      
      if (!selectedFile) {
        addLog('ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
      
      const statusDiv = document.getElementById('uploadStatus');
      statusDiv.className = 'warning';
      statusDiv.textContent = 'ğŸ“¤ AssemblyAIë¡œ ì—…ë¡œë“œ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
      statusDiv.classList.remove('hidden');
      
      addLog('ì—…ë¡œë“œ ì‹œì‘: ' + selectedFile.name, 'info');
      addLog('Vercelì„ ê±°ì¹˜ì§€ ì•Šê³  AssemblyAIë¡œ ì§ì ‘ ì—…ë¡œë“œí•©ë‹ˆë‹¤', 'info');
      
      try {
        // Step 1: AssemblyAIì— ì§ì ‘ ì—…ë¡œë“œ
        addLog('Step 1: AssemblyAI ì§ì ‘ ì—…ë¡œë“œ ì‹œì‘', 'info');
        const startTime = Date.now();
        
        const uploadResponse = await fetch('https://api.assemblyai.com/v2/upload', {
          method: 'POST',
          headers: {
            'authorization': apiKeys.assemblyAI
          },
          body: selectedFile
        });
        
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        addLog('ì—…ë¡œë“œ ì‘ë‹µ ìˆ˜ì‹  (ì†Œìš”ì‹œê°„: ' + elapsed + 'ì´ˆ)', 'info');
        addLog('HTTP ìƒíƒœ: ' + uploadResponse.status, uploadResponse.ok ? 'success' : 'error');
        
        if (!uploadResponse.ok) {
          const errorText = await uploadResponse.text();
          addLog('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + errorText, 'error');
          statusDiv.className = 'error';
          statusDiv.textContent = 'âŒ ì—…ë¡œë“œ ì‹¤íŒ¨ (HTTP ' + uploadResponse.status + ')\n\n' + errorText;
          throw new Error('AssemblyAI ì—…ë¡œë“œ ì‹¤íŒ¨: ' + errorText);
        }
        
        const uploadData = await uploadResponse.json();
        addLog('ì—…ë¡œë“œ ì„±ê³µ! Upload URL: ' + uploadData.upload_url, 'success');
        
        // Step 2: ìŒì„± ì¸ì‹ ìš”ì²­
        addLog('Step 2: ìŒì„± ì¸ì‹ ìš”ì²­ ì‹œì‘', 'info');
        
        const transcribeResponse = await fetch('https://api.assemblyai.com/v2/transcript', {
          method: 'POST',
          headers: {
            'authorization': apiKeys.assemblyAI,
            'content-type': 'application/json'
          },
          body: JSON.stringify({
            audio_url: uploadData.upload_url,
            language_code: 'ja',
            speech_model: 'best'
          })
        });
        
        if (!transcribeResponse.ok) {
          const errorText = await transcribeResponse.text();
          addLog('ìŒì„± ì¸ì‹ ìš”ì²­ ì‹¤íŒ¨: ' + errorText, 'error');
          throw new Error('ìŒì„± ì¸ì‹ ìš”ì²­ ì‹¤íŒ¨: ' + errorText);
        }
        
        const transcribeData = await transcribeResponse.json();
        transcriptionId = transcribeData.id;
        
        addLog('ìŒì„± ì¸ì‹ ì‹œì‘! Transcription ID: ' + transcriptionId, 'success');
        
        statusDiv.className = 'success';
        statusDiv.textContent = 'âœ… ì—…ë¡œë“œ ì™„ë£Œ!\n\nìŒì„± ì¸ì‹ì„ ì‹œì‘í•©ë‹ˆë‹¤...';
        
        // ìŒì„± ì¸ì‹ ë‹¨ê³„ë¡œ ì´ë™
        setTimeout(() => {
          step1.classList.add('hidden');
          step2.classList.remove('hidden');
          checkTranscriptionStatus();
        }, 2000);
        
      } catch (error) {
        addLog('=== ì—…ë¡œë“œ ì‹¤íŒ¨ ===', 'error');
        addLog('ì—ëŸ¬: ' + error.message, 'error');
        
        statusDiv.className = 'error';
        statusDiv.textContent = 'âŒ ì—…ë¡œë“œ ì‹¤íŒ¨\n\n' + error.message;
        
        alert('ì—…ë¡œë“œ ì‹¤íŒ¨\n\n' + error.message + '\n\në¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'ë‹¤ì‹œ ì‹œë„';
      }
    });

    // ìŒì„± ì¸ì‹ ìƒíƒœ ì²´í¬ - AssemblyAI ì§ì ‘ í˜¸ì¶œ
    async function checkTranscriptionStatus() {
      addLog('ìŒì„± ì¸ì‹ ìƒíƒœ ì²´í¬ ì‹œì‘', 'info');
      
      const interval = setInterval(async () => {
        try {
          const response = await fetch('https://api.assemblyai.com/v2/transcript/' + transcriptionId, {
            headers: {
              'authorization': apiKeys.assemblyAI
            }
          });
          
          const data = await response.json();
          
          addLog('ìŒì„± ì¸ì‹ ìƒíƒœ: ' + data.status, 'info');
          document.getElementById('transcribeStatus').textContent = 'ìƒíƒœ: ' + data.status;
          
          if (data.status === 'completed') {
            clearInterval(interval);
            japaneseText = data.text;
            
            addLog('ìŒì„± ì¸ì‹ ì™„ë£Œ!', 'success');
            addLog('ì¶”ì¶œëœ í…ìŠ¤íŠ¸ ê¸¸ì´: ' + japaneseText.length + 'ì', 'info');
            
            step2.classList.add('hidden');
            step3.classList.remove('hidden');
            document.getElementById('japaneseResult').textContent = japaneseText;
            
            // ìë™ìœ¼ë¡œ ë²ˆì—­ ì‹œì‘
            translateText();
          } else if (data.status === 'error') {
            clearInterval(interval);
            addLog('ìŒì„± ì¸ì‹ ì‹¤íŒ¨: ' + data.error, 'error');
            alert('ìŒì„± ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
          }
        } catch (error) {
          clearInterval(interval);
          addLog('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ' + error.message, 'error');
          alert('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ' + error.message);
        }
      }, 3000);
    }

    // ë²ˆì—­
    async function translateText() {
      addLog('ë²ˆì—­ ì‹œì‘', 'info');
      document.getElementById('translating').classList.remove('hidden');
      
      try {
        const response = await fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            text: japaneseText,
            openAIKey: apiKeys.openAI
          })
        });
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'ë²ˆì—­ ì‹¤íŒ¨');
        }
        
        koreanText = data.translatedText;
        
        addLog('ë²ˆì—­ ì™„ë£Œ', 'success');
        
        document.getElementById('translating').classList.add('hidden');
        document.getElementById('koreanResult').classList.remove('hidden');
        document.getElementById('koreanResult').textContent = koreanText;
        document.getElementById('analyzeBtn').classList.remove('hidden');
        
      } catch (error) {
        addLog('ë²ˆì—­ ì‹¤íŒ¨: ' + error.message, 'error');
        alert('ë²ˆì—­ ì‹¤íŒ¨: ' + error.message);
      }
    }

    // ìŠ¤í† ë¦¬ ë¶„ì„
    document.getElementById('analyzeBtn').addEventListener('click', async function() {
      addLog('ìŠ¤í† ë¦¬ ë¶„ì„ ì‹œì‘', 'info');
      
      step3.classList.add('hidden');
      step2.classList.remove('hidden');
      document.querySelector('#step2 h2').textContent = 'ğŸ“Š ìŠ¤í† ë¦¬ ë¶„ì„ ì¤‘...';
      document.querySelector('#step2 p').textContent = 'ìŠ¤í† ë¦¬ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
      
      try {
        const response = await fetch('/api/analyze-story', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            text: koreanText,
            openAIKey: apiKeys.openAI
          })
        });
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'ë¶„ì„ ì‹¤íŒ¨');
        }
        
        storyAnalysis = data.analysis;
        
        addLog('ìŠ¤í† ë¦¬ ë¶„ì„ ì™„ë£Œ', 'success');
        
        step2.classList.add('hidden');
        step4.classList.remove('hidden');
        document.getElementById('analysisResult').textContent = storyAnalysis;
        
        // UI ë³µì›
        document.querySelector('#step2 h2').textContent = 'ğŸ¤ ìŒì„± ì¸ì‹ ì¤‘';
        document.querySelector('#step2 p').textContent = 'ì¼ë³¸ì–´ ëŒ€ì‚¬ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        
      } catch (error) {
        addLog('ë¶„ì„ ì‹¤íŒ¨: ' + error.message, 'error');
        alert('ë¶„ì„ ì‹¤íŒ¨: ' + error.message);
        
        step2.classList.add('hidden');
        step3.classList.remove('hidden');
      }
    });

    // ê´‘ê³  ë¬¸êµ¬ ìƒì„±
    document.getElementById('generateAdBtn').addEventListener('click', async function() {
      addLog('ê´‘ê³  ë¬¸êµ¬ ìƒì„± ì‹œì‘', 'info');
      
      step4.classList.add('hidden');
      step2.classList.remove('hidden');
      document.querySelector('#step2 h2').textContent = 'âœ¨ ê´‘ê³  ë¬¸êµ¬ ìƒì„± ì¤‘...';
      document.querySelector('#step2 p').textContent = 'ë§ì¶¤í˜• ê´‘ê³  ë¬¸êµ¬ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
      
      try {
        const criteria = {
          targetAge: document.getElementById('targetAge').value,
          tone: document.getElementById('tone').value,
          platform: document.getElementById('platform').value,
          length: 'ì§§ê²Œ (1-2ì¤„)',
          keyword: document.getElementById('keyword').value
        };
        
        const response = await fetch('/api/generate-ad', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            story: koreanText,
            analysis: storyAnalysis,
            criteria: criteria,
            openAIKey: apiKeys.openAI
          })
        });
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'ê´‘ê³  ìƒì„± ì‹¤íŒ¨');
        }
        
        addLog('ê´‘ê³  ë¬¸êµ¬ ìƒì„± ì™„ë£Œ', 'success');
        
        step2.classList.add('hidden');
        step5.classList.remove('hidden');
        document.getElementById('adResult').textContent = data.adCopy;
        
        // UI ë³µì›
        document.querySelector('#step2 h2').textContent = 'ğŸ¤ ìŒì„± ì¸ì‹ ì¤‘';
        document.querySelector('#step2 p').textContent = 'ì¼ë³¸ì–´ ëŒ€ì‚¬ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        
      } catch (error) {
        addLog('ê´‘ê³  ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
        alert('ê´‘ê³  ìƒì„± ì‹¤íŒ¨: ' + error.message);
        
        step2.classList.add('hidden');
        step4.classList.remove('hidden');
      }
    });

    // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
    document.getElementById('downloadBtn').addEventListener('click', function() {
      const content = '=== KANTA ë¶„ì„ ê²°ê³¼ ===\n\nì¼ë³¸ì–´:\n' + japaneseText + '\n\ní•œê¸€:\n' + koreanText + '\n\në¶„ì„:\n' + storyAnalysis + '\n\nê´‘ê³ :\n' + document.getElementById('adResult').textContent;
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kanta-result.txt';
      a.click();
      URL.revokeObjectURL(url);
      
      addLog('ê²°ê³¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
    });
    
    addLog('ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ', 'success');
    addLog('ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ âœ…', 'success');
  </script>
</body>
</html>
