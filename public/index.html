<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KANTA ìˆë“œë¼ë§ˆ ë¶„ì„ê¸°</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState } = React;

    function App() {
      const [apiKeys, setApiKeys] = useState({
        assemblyAI: '',
        openAI: ''
      });
      const [step, setStep] = useState(0);
      const [videoFile, setVideoFile] = useState(null);
      const [uploading, setUploading] = useState(false);
      const [transcribing, setTranscribing] = useState(false);
      const [translating, setTranslating] = useState(false);
      const [analyzing, setAnalyzing] = useState(false);
      const [generatingAd, setGeneratingAd] = useState(false);
      
      const [japaneseText, setJapaneseText] = useState('');
      const [koreanText, setKoreanText] = useState('');
      const [storyAnalysis, setStoryAnalysis] = useState('');
      const [adCopy, setAdCopy] = useState('');
      
      const [adCriteria, setAdCriteria] = useState({
        targetAge: '20-30ëŒ€',
        tone: 'ê°ì„±ì ',
        platform: 'ì¸ìŠ¤íƒ€ê·¸ë¨',
        length: 'ì§§ê²Œ (1-2ì¤„)',
        keyword: ''
      });

      const handleSaveKeys = () => {
        if (!apiKeys.assemblyAI.trim() || !apiKeys.openAI.trim()) {
          alert('ë‘ ê°œì˜ API í‚¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        setStep(1);
      };

      const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('video/')) {
          setVideoFile(file);
        } else {
          alert('ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        }
      };

      const handleUpload = async () => {
        if (!videoFile) {
          alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        // íŒŒì¼ í¬ê¸° ì²´í¬ (500MB ì œí•œ)
        if (videoFile.size > 500 * 1024 * 1024) {
          alert('íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. 500MB ì´í•˜ì˜ ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }

        setUploading(true);
        try {
          console.log('ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:', videoFile.name, 'í¬ê¸°:', (videoFile.size / 1024 / 1024).toFixed(2) + 'MB');
          
          // íŒŒì¼ì„ ArrayBufferë¡œ ì½ê¸°
          const arrayBuffer = await videoFile.arrayBuffer();
          console.log('âœ… ArrayBuffer ìƒì„± ì™„ë£Œ');
          
          // AssemblyAIì— ì§ì ‘ ì—…ë¡œë“œ
          console.log('ğŸš€ AssemblyAIë¡œ ì—…ë¡œë“œ ì¤‘...');
          const uploadResponse = await fetch('https://api.assemblyai.com/v2/upload', {
            method: 'POST',
            headers: {
              'authorization': apiKeys.assemblyAI,
            },
            body: arrayBuffer
          });

          console.log('ğŸ“Š ì—…ë¡œë“œ ì‘ë‹µ ìƒíƒœ:', uploadResponse.status);

          if (!uploadResponse.ok) {
            const errorText = await uploadResponse.text();
            throw new Error(`ì—…ë¡œë“œ ì‹¤íŒ¨ (${uploadResponse.status}): ${errorText}`);
          }

          const uploadData = await uploadResponse.json();
          console.log('âœ… ì—…ë¡œë“œ ì„±ê³µ! URL:', uploadData.upload_url);
          
          setStep(2);
          handleTranscribe(uploadData.upload_url);
        } catch (error) {
          console.error('âŒ ì—…ë¡œë“œ ì—ëŸ¬:', error);
          alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
        } finally {
          setUploading(false);
        }
      };

      const handleTranscribe = async (videoUrl) => {
        setTranscribing(true);
        try {
          const response = await fetch('/api/transcribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              videoUrl,
              assemblyAIKey: apiKeys.assemblyAI
            })
          });
          
          const data = await response.json();
          if (!data.success) throw new Error(data.error);
          
          checkTranscriptionStatus(data.transcriptionId);
        } catch (error) {
          alert('ìŒì„± ì¸ì‹ ì‹¤íŒ¨: ' + error.message);
          setTranscribing(false);
        }
      };

      const checkTranscriptionStatus = async (id) => {
        const interval = setInterval(async () => {
          try {
            const response = await fetch(`/api/status?id=${id}&assemblyAIKey=${apiKeys.assemblyAI}`);
            const data = await response.json();
            
            if (data.status === 'completed') {
              clearInterval(interval);
              setJapaneseText(data.text);
              setTranscribing(false);
              setStep(3);
              handleTranslate(data.text);
            } else if (data.status === 'error') {
              clearInterval(interval);
              setTranscribing(false);
              alert('ìŒì„± ì¸ì‹ ì‹¤íŒ¨');
            }
          } catch (error) {
            clearInterval(interval);
            setTranscribing(false);
          }
        }, 3000);
      };

      const handleTranslate = async (text) => {
        setTranslating(true);
        try {
          const response = await fetch('/api/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              text,
              openAIKey: apiKeys.openAI
            })
          });
          
          const data = await response.json();
          if (!data.success) throw new Error(data.error);
          
          setKoreanText(data.translatedText);
          setStep(4);
        } catch (error) {
          alert('ë²ˆì—­ ì‹¤íŒ¨: ' + error.message);
        } finally {
          setTranslating(false);
        }
      };

      const handleAnalyzeStory = async () => {
        setAnalyzing(true);
        try {
          const response = await fetch('/api/analyze-story', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              text: koreanText,
              openAIKey: apiKeys.openAI
            })
          });
          
          const data = await response.json();
          if (!data.success) throw new Error(data.error);
          
          setStoryAnalysis(data.analysis);
          setStep(5);
        } catch (error) {
          alert('ë¶„ì„ ì‹¤íŒ¨: ' + error.message);
        } finally {
          setAnalyzing(false);
        }
      };

      const handleGenerateAd = async () => {
        setGeneratingAd(true);
        try {
          const response = await fetch('/api/generate-ad', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              story: koreanText,
              analysis: storyAnalysis,
              criteria: adCriteria,
              openAIKey: apiKeys.openAI
            })
          });
          
          const data = await response.json();
          if (!data.success) throw new Error(data.error);
          
          setAdCopy(data.adCopy);
          setStep(6);
        } catch (error) {
          alert('ê´‘ê³  ìƒì„± ì‹¤íŒ¨: ' + error.message);
        } finally {
          setGeneratingAd(false);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 p-6">
          <div className="max-w-6xl mx-auto">
            <div className="text-center mb-8">
              <h1 className="text-4xl font-bold text-gray-800 mb-2">ğŸ¬ KANTA ìˆë“œë¼ë§ˆ ë¶„ì„ê¸°</h1>
              <p className="text-gray-600">ì¼ë³¸ ë“œë¼ë§ˆ ëŒ€ì‚¬ë¥¼ ìë™ìœ¼ë¡œ ë²ˆì—­í•˜ê³  ë¶„ì„í•´ì„œ ê´‘ê³  ë¬¸êµ¬ë¥¼ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤</p>
            </div>

            {step === 0 && (
              <div className="bg-white rounded-lg shadow-lg p-8">
                <h2 className="text-2xl font-bold mb-6">ğŸ”‘ API í‚¤ ì„¤ì •</h2>
                
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                  <p className="text-sm text-blue-800 font-medium mb-2">ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
                  <ul className="list-disc list-inside space-y-1 text-xs text-blue-700">
                    <li>AssemblyAI: ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜</li>
                    <li>OpenAI: ë²ˆì—­, ë¶„ì„, ê´‘ê³  ìƒì„±</li>
                  </ul>
                </div>

                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-medium mb-2">
                      AssemblyAI API Key
                      <a href="https://www.assemblyai.com/dashboard" target="_blank" className="ml-2 text-purple-600 hover:underline text-xs">
                        (ë°œê¸‰ë°›ê¸° â†’)
                      </a>
                    </label>
                    <input
                      type="password"
                      value={apiKeys.assemblyAI}
                      onChange={(e) => setApiKeys({...apiKeys, assemblyAI: e.target.value})}
                      placeholder="AssemblyAI API í‚¤"
                      className="w-full border rounded-lg p-3"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">
                      OpenAI API Key
                      <a href="https://platform.openai.com/api-keys" target="_blank" className="ml-2 text-purple-600 hover:underline text-xs">
                        (ë°œê¸‰ë°›ê¸° â†’)
                      </a>
                    </label>
                    <input
                      type="password"
                      value={apiKeys.openAI}
                      onChange={(e) => setApiKeys({...apiKeys, openAI: e.target.value})}
                      placeholder="OpenAI API í‚¤"
                      className="w-full border rounded-lg p-3"
                    />
                  </div>
                </div>

                <button
                  onClick={handleSaveKeys}
                  className="w-full mt-6 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700"
                >
                  API í‚¤ ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°
                </button>
              </div>
            )}

            {step > 0 && (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div className="flex justify-between items-center">
                  {[
                    { num: 1, label: 'ì˜ìƒ ì—…ë¡œë“œ' },
                    { num: 2, label: 'ìŒì„± ì¸ì‹' },
                    { num: 3, label: 'í•œê¸€ ë²ˆì—­' },
                    { num: 4, label: 'ìŠ¤í† ë¦¬ ë¶„ì„' },
                    { num: 5, label: 'ê´‘ê³  ì„¤ì •' },
                    { num: 6, label: 'ê´‘ê³  ìƒì„±' }
                  ].map((s) => (
                    <div key={s.num} className="flex flex-col items-center">
                      <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${
                        step >= s.num ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-500'
                      }`}>
                        {step > s.num ? 'âœ“' : s.num}
                      </div>
                      <p className="text-xs mt-2 text-center w-20">{s.label}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {step === 1 && (
              <div className="bg-white rounded-lg shadow-lg p-8">
                <h2 className="text-2xl font-bold mb-4">ğŸ“¹ ì˜ìƒ ì—…ë¡œë“œ</h2>
                
                <div className="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-purple-400 transition-colors">
                  <input
                    type="file"
                    accept="video/*"
                    onChange={handleFileChange}
                    className="hidden"
                    id="video-upload"
                  />
                  <label htmlFor="video-upload" className="cursor-pointer">
                    <div className="text-6xl mb-4">ğŸ“</div>
                    <p className="text-lg font-medium mb-2">
                      {videoFile ? `âœ… ${videoFile.name}` : 'í´ë¦­í•´ì„œ ì˜ìƒ ì„ íƒ'}
                    </p>
                    {videoFile && (
                      <p className="text-sm text-gray-500">
                        í¬ê¸°: {(videoFile.size / 1024 / 1024).toFixed(2)}MB
                      </p>
                    )}
                    <p className="text-sm text-gray-500 mt-2">MP4, MOV, AVI ë“± ì§€ì› (ìµœëŒ€ 500MB)</p>
                  </label>
                </div>

                {videoFile && (
                  <button
                    onClick={handleUpload}
                    disabled={uploading}
                    className="w-full mt-6 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 disabled:bg-gray-400"
                  >
                    {uploading ? 'ì—…ë¡œë“œ ì¤‘...' : 'ì—…ë¡œë“œ ì‹œì‘'}
                  </button>
                )}
              </div>
            )}

            {step === 2 && transcribing && (
              <div className="bg-white rounded-lg shadow-lg p-8 text-center">
                <div className="text-6xl mb-4">â³</div>
                <h2 className="text-2xl font-bold mb-2">ìŒì„± ì¸ì‹ ì¤‘...</h2>
                <p className="text-gray-600">ì¼ë³¸ì–´ ëŒ€ì‚¬ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
              </div>
            )}

            {step >= 3 && (
              <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 className="text-2xl font-bold mb-4">ğŸ“ ì¼ë³¸ì–´ ì›ë¬¸</h2>
                <div className="bg-gray-50 p-4 rounded-lg mb-4 max-h-64 overflow-y-auto">
                  <p className="whitespace-pre-wrap">{japaneseText}</p>
                </div>

                {translating && (
                  <div className="text-center text-purple-600 my-4">ë²ˆì—­ ì¤‘...</div>
                )}

                {koreanText && (
                  <>
                    <h2 className="text-2xl font-bold mb-4 mt-6">ğŸ‡°ğŸ‡· í•œê¸€ ë²ˆì—­</h2>
                    <div className="bg-purple-50 p-4 rounded-lg max-h-64 overflow-y-auto">
                      <p className="whitespace-pre-wrap">{koreanText}</p>
                    </div>
                  </>
                )}
              </div>
            )}

            {step === 4 && (
              <div className="bg-white rounded-lg shadow-lg p-8">
                <h2 className="text-2xl font-bold mb-4">ğŸ“Š ìŠ¤í† ë¦¬ ë¶„ì„</h2>
                <p className="text-gray-600 mb-4">ë²ˆì—­ëœ ëŒ€ì‚¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìŠ¤í† ë¦¬ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤</p>
                <button
                  onClick={handleAnalyzeStory}
                  disabled={analyzing}
                  className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
                >
                  {analyzing ? 'ë¶„ì„ ì¤‘...' : 'ìŠ¤í† ë¦¬ ë¶„ì„ ì‹œì‘'}
                </button>

                {storyAnalysis && (
                  <div className="mt-6 bg-blue-50 p-6 rounded-lg">
                    <h3 className="font-bold mb-3">ğŸ“ˆ ë¶„ì„ ê²°ê³¼:</h3>
                    <p className="whitespace-pre-wrap">{storyAnalysis}</p>
                  </div>
                )}
              </div>
            )}

            {step === 5 && (
              <div className="bg-white rounded-lg shadow-lg p-8">
                <h2 className="text-2xl font-bold mb-4">ğŸ¯ ê´‘ê³  ë¬¸êµ¬ ê¸°ì¤€ ì„¤ì •</h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">íƒ€ê²Ÿ ì—°ë ¹ëŒ€</label>
                    <select
                      value={adCriteria.targetAge}
                      onChange={(e) => setAdCriteria({...adCriteria, targetAge: e.target.value})}
                      className="w-full border rounded-lg p-3"
                    >
                      <option>10ëŒ€</option>
                      <option>20-30ëŒ€</option>
                      <option>40-50ëŒ€</option>
                      <option>ì „ì—°ë ¹</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">í†¤ & ë¬´ë“œ</label>
                    <select
                      value={adCriteria.tone}
                      onChange={(e) => setAdCriteria({...adCriteria, tone: e.target.value})}
                      className="w-full border rounded-lg p-3"
                    >
                      <option>ê°ì„±ì </option>
                      <option>ìœ ë¨¸ëŸ¬ìŠ¤</option>
                      <option>ì§„ì§€í•œ</option>
                      <option>ì„¤ë ˆëŠ”</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">í”Œë«í¼</label>
                    <select
                      value={adCriteria.platform}
                      onChange={(e) => setAdCriteria({...adCriteria, platform: e.target.value})}
                      className="w-full border rounded-lg p-3"
                    >
                      <option>ì¸ìŠ¤íƒ€ê·¸ë¨</option>
                      <option>ìœ íŠœë¸Œ</option>
                      <option>í‹±í†¡</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">ë¬¸êµ¬ ê¸¸ì´</label>
                    <select
                      value={adCriteria.length}
                      onChange={(e) => setAdCriteria({...adCriteria, length: e.target.value})}
                      className="w-full border rounded-lg p-3"
                    >
                      <option>ì§§ê²Œ (1-2ì¤„)</option>
                      <option>ì¤‘ê°„ (3-4ì¤„)</option>
                      <option>ê¸¸ê²Œ (5ì¤„ ì´ìƒ)</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">í‚¤ì›Œë“œ (ì„ íƒ)</label>
                    <input
                      type="text"
                      value={adCriteria.keyword}
                      onChange={(e) => setAdCriteria({...adCriteria, keyword: e.target.value})}
                      placeholder="ì˜ˆ: ë¡œë§¨ìŠ¤, ë°˜ì „"
                      className="w-full border rounded-lg p-3"
                    />
                  </div>
                </div>

                <button
                  onClick={handleGenerateAd}
                  disabled={generatingAd}
                  className="w-full mt-6 bg-pink-600 text-white py-3 rounded-lg hover:bg-pink-700 disabled:bg-gray-400"
                >
                  {generatingAd ? 'ìƒì„± ì¤‘...' : 'ê´‘ê³  ë¬¸êµ¬ ìƒì„±'}
                </button>
              </div>
            )}

            {step === 6 && (
              <div className="bg-white rounded-lg shadow-lg p-8">
                <h2 className="text-2xl font-bold mb-6">âœ¨ ìƒì„±ëœ ê´‘ê³  ë¬¸êµ¬</h2>
                <div className="bg-gradient-to-r from-pink-100 to-purple-100 p-8 rounded-lg mb-6 border-2 border-purple-200">
                  <p className="text-xl font-medium whitespace-pre-wrap leading-relaxed">{adCopy}</p>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <button
                    onClick={() => {
                      const content = `=== KANTA ë¶„ì„ ê²°ê³¼ ===\n\nì¼ë³¸ì–´:\n${japaneseText}\n\ní•œê¸€:\n${koreanText}\n\në¶„ì„:\n${storyAnalysis}\n\nê´‘ê³ :\n${adCopy}`;
                      const blob = new Blob([content], { type: 'text/plain' });
                      const url = URL.createObjectURL(blob);
                      const a = document.createElement('a');
                      a.href = url;
                      a.download = 'kanta-result.txt';
                      a.click();
                      URL.revokeObjectURL(url);
                    }}
                    className="bg-green-600 text-white py-3 rounded-lg hover:bg-green-700"
                  >
                    ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
                  </button>
                  <button
                    onClick={() => {
                      setStep(1);
                      setVideoFile(null);
                      setJapaneseText('');
                      setKoreanText('');
                      setStoryAnalysis('');
                      setAdCopy('');
                    }}
                    className="bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700"
                  >
                    ğŸ”„ ìƒˆë¡œìš´ ë¶„ì„
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
