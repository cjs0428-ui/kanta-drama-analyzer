<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KANTA ìˆë“œë¼ë§ˆ ë¶„ì„ê¸°</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #f5f3ff 0%, #fce7f3 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 20px; }
    h1 { font-size: 2.5rem; text-align: center; margin-bottom: 10px; }
    p { text-align: center; color: #666; margin-bottom: 30px; }
    label { display: block; font-weight: 600; margin-bottom: 8px; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; font-size: 16px; }
    button { width: 100%; padding: 15px; background: #9333ea; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    button:hover { background: #7e22ce; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .file-zone { border: 2px dashed #ddd; border-radius: 8px; padding: 60px 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
    .file-zone:hover { border-color: #9333ea; background: #faf5ff; }
    .file-zone .icon { font-size: 4rem; margin-bottom: 20px; }
    .hidden { display: none; }
    .progress { text-align: center; padding: 40px; }
    .progress .spinner { font-size: 4rem; animation: spin 2s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .result { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 20px; margin-top: 20px; white-space: pre-wrap; line-height: 1.6; }
    .info { background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 14px; color: #1e40af; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ KANTA ìˆë“œë¼ë§ˆ ë¶„ì„ê¸°</h1>
    <p>ì¼ë³¸ ë“œë¼ë§ˆ ëŒ€ì‚¬ë¥¼ ìë™ìœ¼ë¡œ ë²ˆì—­í•˜ê³  ë¶„ì„í•´ì„œ ê´‘ê³  ë¬¸êµ¬ë¥¼ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤</p>

    <!-- Step 0: API í‚¤ ì…ë ¥ -->
    <div id="step0" class="card">
      <h2>ğŸ”‘ API í‚¤ ì„¤ì •</h2>
      <div class="info">
        <p style="margin: 0;">ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
        <ul style="margin-left: 20px; margin-top: 10px;">
          <li>AssemblyAI: ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜</li>
          <li>OpenAI: ë²ˆì—­, ë¶„ì„, ê´‘ê³  ìƒì„±</li>
        </ul>
      </div>
      
      <label>AssemblyAI API Key 
        <a href="https://www.assemblyai.com/dashboard" target="_blank" style="color: #9333ea; font-size: 12px;">(ë°œê¸‰ë°›ê¸° â†’)</a>
      </label>
      <input type="password" id="assemblyKey" placeholder="AssemblyAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      
      <label>OpenAI API Key 
        <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #9333ea; font-size: 12px;">(ë°œê¸‰ë°›ê¸° â†’)</a>
      </label>
      <input type="password" id="openaiKey" placeholder="OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      
      <button onclick="saveKeys()">API í‚¤ ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
    </div>

    <!-- Step 1: ì˜ìƒ ì—…ë¡œë“œ -->
    <div id="step1" class="card hidden">
      <h2>ğŸ“¹ ì˜ìƒ ì—…ë¡œë“œ</h2>
      
      <div class="file-zone" onclick="document.getElementById('videoInput').click()">
        <div class="icon">ğŸ“</div>
        <p id="fileName" style="font-size: 18px; font-weight: 600;">í´ë¦­í•´ì„œ ì˜ìƒ ì„ íƒ</p>
        <p id="fileSize" style="font-size: 14px; color: #666;"></p>
      </div>
      <input type="file" id="videoInput" accept="video/*" class="hidden" onchange="selectFile(this)">
      
      <button id="uploadBtn" class="hidden" onclick="uploadVideo()">ì—…ë¡œë“œ ì‹œì‘</button>
    </div>

    <!-- Step 2: ì§„í–‰ ì¤‘ -->
    <div id="step2" class="card hidden">
      <div class="progress">
        <div class="spinner">â³</div>
        <h2 id="statusText">ì²˜ë¦¬ ì¤‘...</h2>
        <p id="statusDetail" style="color: #666; margin-top: 10px;"></p>
      </div>
    </div>

    <!-- Step 3: ìŒì„± ì¸ì‹ -->
    <div id="step3" class="card hidden">
      <h2>ğŸ¤ ìŒì„± ì¸ì‹ ì¤‘</h2>
      <div class="progress">
        <div class="spinner">â³</div>
        <p id="transcribeStatus">ì¼ë³¸ì–´ ëŒ€ì‚¬ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
      </div>
    </div>

    <!-- Step 4: ê²°ê³¼ -->
    <div id="step4" class="card hidden">
      <h2>ğŸ“ ì¼ë³¸ì–´ ëŒ€ì‚¬ (ì›ë¬¸)</h2>
      <div class="result" id="japaneseResult"></div>
      
      <h2 style="margin-top: 30px;">ğŸ‡°ğŸ‡· í•œê¸€ ë²ˆì—­</h2>
      <div id="translating" class="progress hidden">
        <div class="spinner" style="font-size: 2rem;">â³</div>
        <p>ë²ˆì—­ ì¤‘...</p>
      </div>
      <div class="result hidden" id="koreanResult"></div>
      
      <button onclick="analyzeStory()" id="analyzeBtn" class="hidden" style="margin-top: 20px;">ìŠ¤í† ë¦¬ ë¶„ì„í•˜ê¸°</button>
    </div>

    <!-- Step 5: ìŠ¤í† ë¦¬ ë¶„ì„ -->
    <div id="step5" class="card hidden">
      <h2>ğŸ“Š ìŠ¤í† ë¦¬ ë¶„ì„</h2>
      <div class="result" id="analysisResult"></div>
      
      <h2 style="margin-top: 30px;">ğŸ¯ ê´‘ê³  ë¬¸êµ¬ ê¸°ì¤€ ì„¤ì •</h2>
      
      <label>íƒ€ê²Ÿ ì—°ë ¹ëŒ€</label>
      <select id="targetAge">
        <option>10ëŒ€</option>
        <option selected>20-30ëŒ€</option>
        <option>40-50ëŒ€</option>
        <option>ì „ì—°ë ¹</option>
      </select>
      
      <label>í†¤ & ë¬´ë“œ</label>
      <select id="tone">
        <option selected>ê°ì„±ì </option>
        <option>ìœ ë¨¸ëŸ¬ìŠ¤</option>
        <option>ì§„ì§€í•œ</option>
        <option>ì„¤ë ˆëŠ”</option>
      </select>
      
      <label>í”Œë«í¼</label>
      <select id="platform">
        <option selected>ì¸ìŠ¤íƒ€ê·¸ë¨</option>
        <option>ìœ íŠœë¸Œ</option>
        <option>í‹±í†¡</option>
      </select>
      
      <label>í‚¤ì›Œë“œ (ì„ íƒ)</label>
      <input type="text" id="keyword" placeholder="ì˜ˆ: ë¡œë§¨ìŠ¤, ë°˜ì „">
      
      <button onclick="generateAd()">ê´‘ê³  ë¬¸êµ¬ ìƒì„±</button>
    </div>

    <!-- Step 6: ê´‘ê³  ë¬¸êµ¬ -->
    <div id="step6" class="card hidden">
      <h2>âœ¨ ìƒì„±ëœ ê´‘ê³  ë¬¸êµ¬</h2>
      <div class="result" id="adResult" style="background: linear-gradient(135deg, #fce7f3 0%, #f3e8ff 100%); font-size: 18px;"></div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
        <button onclick="downloadResult()" style="background: #16a34a;">ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="location.reload()" style="background: #6b7280;">ğŸ”„ ìƒˆë¡œìš´ ë¶„ì„</button>
      </div>
    </div>
  </div>

  <script>
    console.log('ğŸŸ¢ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');
    
    let apiKeys = { assemblyAI: '', openAI: '' };
    let selectedFile = null;
    let transcriptionId = null;
    let japaneseText = '';
    let koreanText = '';
    let storyAnalysis = '';

    function saveKeys() {
      const assemblyKey = document.getElementById('assemblyKey').value.trim();
      const openaiKey = document.getElementById('openaiKey').value.trim();
      
      if (!assemblyKey || !openaiKey) {
        alert('ë‘ ê°œì˜ API í‚¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      apiKeys.assemblyAI = assemblyKey;
      apiKeys.openAI = openaiKey;
      
      console.log('âœ… API í‚¤ ì €ì¥ë¨');
      
      document.getElementById('step0').classList.add('hidden');
      document.getElementById('step1').classList.remove('hidden');
    }

    function selectFile(input) {
      const file = input.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('video/')) {
        alert('ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }
      
      selectedFile = file;
      console.log('ğŸ“ íŒŒì¼ ì„ íƒë¨:', file.name, file.size);
      
      document.getElementById('fileName').textContent = 'âœ… ' + file.name;
      document.getElementById('fileSize').textContent = 'í¬ê¸°: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB';
      document.getElementById('uploadBtn').classList.remove('hidden');
    }

    async function uploadVideo() {
      if (!selectedFile) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      console.log('ğŸ“¤ Vercel Blobìœ¼ë¡œ ì—…ë¡œë“œ ì‹œì‘');
      
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
      document.getElementById('statusText').textContent = 'Vercel Blobì— ì—…ë¡œë“œ ì¤‘...';
      document.getElementById('statusDetail').textContent = selectedFile.name;
      
      try {
        const response = await fetch('/api/upload-blob?assemblyAIKey=' + encodeURIComponent(apiKeys.assemblyAI), {
          method: 'POST',
          body: selectedFile
        });
        
        console.log('ğŸ“Š ì‘ë‹µ:', response.status);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        console.log('âœ… ì—…ë¡œë“œ ì„±ê³µ:', data);
        
        transcriptionId = data.transcriptionId;
        
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.remove('hidden');
        
        checkTranscriptionStatus();
        
      } catch (error) {
        console.error('âŒ ì—ëŸ¬:', error);
        document.getElementById('statusText').textContent = 'ì—…ë¡œë“œ ì‹¤íŒ¨';
        document.getElementById('statusDetail').textContent = error.message;
        alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
      }
    }

    async function checkTranscriptionStatus() {
      const interval = setInterval(async () => {
        try {
          const response = await fetch('/api/status?id=' + transcriptionId + '&assemblyAIKey=' + encodeURIComponent(apiKeys.assemblyAI));
          const data = await response.json();
          
          console.log('â³ ìƒíƒœ:', data.status);
          
          if (data.status === 'completed') {
            clearInterval(interval);
            japaneseText = data.text;
            
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.remove('hidden');
            document.getElementById('japaneseResult').textContent = japaneseText;
            
            translateText();
          } else if (data.status === 'error') {
            clearInterval(interval);
            alert('ìŒì„± ì¸ì‹ ì‹¤íŒ¨');
          }
        } catch (error) {
          clearInterval(interval);
          alert('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ' + error.message);
        }
      }, 3000);
    }

    async function translateText() {
      document.getElementById('translating').classList.remove('hidden');
      
      try {
        const response = await fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            text: japaneseText,
            openAIKey: apiKeys.openAI
          })
        });
        
        const data = await response.json();
        koreanText = data.translatedText;
        
        document.getElementById('translating').classList.add('hidden');
        document.getElementById('koreanResult').classList.remove('hidden');
        document.getElementById('koreanResult').textContent = koreanText;
        document.getElementById('analyzeBtn').classList.remove('hidden');
        
      } catch (error) {
        alert('ë²ˆì—­ ì‹¤íŒ¨: ' + error.message);
      }
    }

    async function analyzeStory() {
      document.getElementById('step4').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
      document.getElementById('statusText').textContent = 'ìŠ¤í† ë¦¬ ë¶„ì„ ì¤‘...';
      document.getElementById('statusDetail').textContent = '';
      
      try {
        const response = await fetch('/api/analyze-story', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            text: koreanText,
            openAIKey: apiKeys.openAI
          })
        });
        
        const data = await response.json();
        storyAnalysis = data.analysis;
        
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step5').classList.remove('hidden');
        document.getElementById('analysisResult').textContent = storyAnalysis;
        
      } catch (error) {
        alert('ë¶„ì„ ì‹¤íŒ¨: ' + error.message);
      }
    }

    async function generateAd() {
      document.getElementById('step5').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
      document.getElementById('statusText').textContent = 'ê´‘ê³  ë¬¸êµ¬ ìƒì„± ì¤‘...';
      
      try {
        const criteria = {
          targetAge: document.getElementById('targetAge').value,
          tone: document.getElementById('tone').value,
          platform: document.getElementById('platform').value,
          length: 'ì§§ê²Œ (1-2ì¤„)',
          keyword: document.getElementById('keyword').value
        };
        
        const response = await fetch('/api/generate-ad', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            story: koreanText,
            analysis: storyAnalysis,
            criteria: criteria,
            openAIKey: apiKeys.openAI
          })
        });
        
        const data = await response.json();
        
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step6').classList.remove('hidden');
        document.getElementById('adResult').textContent = data.adCopy;
        
      } catch (error) {
        alert('ê´‘ê³  ìƒì„± ì‹¤íŒ¨: ' + error.message);
      }
    }

    function downloadResult() {
      const content = '=== KANTA ë¶„ì„ ê²°ê³¼ ===\n\nì¼ë³¸ì–´:\n' + japaneseText + '\n\ní•œê¸€:\n' + koreanText + '\n\në¶„ì„:\n' + storyAnalysis + '\n\nê´‘ê³ :\n' + document.getElementById('adResult').textContent;
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kanta-result.txt';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    console.log('ğŸŸ¢ ëª¨ë“  í•¨ìˆ˜ ë¡œë“œ ì™„ë£Œ');
  </script>
</body>
</html>
